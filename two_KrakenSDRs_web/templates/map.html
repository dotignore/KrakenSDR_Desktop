<!DOCTYPE html>
<html>
<head>
    <title>Leaflet Map</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
        html, body { height: 100%; margin: 0; padding: 0; }
        #container { display: flex; height: 100%; }
        #sidebar { width: 400px; background-color: #f0f0f0; padding: 10px; box-shadow: 2px 0 5px rgba(0,0,0,0.1); overflow-y: scroll; }
        #map { flex-grow: 1; height: 100%; }
        .leaflet-control-attribution { display: none !important; }
        .session-item { margin-bottom: 5px; }
    </style>
</head>
<body>
    <div id="container">
        <div id="sidebar">
            <div id="session-list"></div>
        </div>
        <div id="map"></div>
    </div>

    <script>
        fetch('/get_coordinates')
        .then(response => response.json())
        .then(data => {
            var coordinates = data.coordinates;
            var linesBySession = data.lines_by_session;
            var sessionData = data.session_data;
            var sdrIdData = data.sdr_id_data;

            var sessionList = document.getElementById('session-list');

            // Создаем основной чекбокс в заголовке
            var header = document.createElement('div');
            var masterCheckbox = document.createElement('input');
            masterCheckbox.type = 'checkbox';
            masterCheckbox.id = 'master-checkbox';
            masterCheckbox.addEventListener('change', function() {
                var allCheckboxes = document.querySelectorAll('.session-item input[type="checkbox"]');
                allCheckboxes.forEach(cb => {
                    if (cb.checked !== masterCheckbox.checked) {
                        cb.checked = masterCheckbox.checked;
                        cb.dispatchEvent(new Event('change'));  // Триггерим событие change
                    }
                });
            });
            header.appendChild(masterCheckbox);

            var headerLabel = document.createElement('label');
            headerLabel.innerHTML = 'ID Freq DateTime DF_1 DF_2';
            header.appendChild(headerLabel);

            sessionList.appendChild(header);

            var earliestFreqBySession = {};
            sessionData.forEach(function(session) {
                var sessionId = session[0];
                var time = session[1];
                var frequency = session[2];
                if (!earliestFreqBySession[sessionId] || new Date(time) < new Date(earliestFreqBySession[sessionId])) {
                    earliestFreqBySession[sessionId] = { time: time, frequency: frequency };
                }
            });

            var sdrIdCountsBySession = {};
            sdrIdData.forEach(function(sdr) {
                var session = sdr[0];
                var sdrId = sdr[1];
                var count = sdr[2];
                if (!sdrIdCountsBySession[session]) {
                    sdrIdCountsBySession[session] = {};
                }
                sdrIdCountsBySession[session][sdrId] = count;
            });

            var map = L.map('map').setView(coordinates[0], 10);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            var sessionLinesMap = {};

            sessionData.forEach(function(session, index) {
                var sessionId = session[0];
                if (sdrIdCountsBySession[sessionId]) {
                    var sdrCounts = sdrIdCountsBySession[sessionId];
                    var df_1 = sdrCounts[1] || 0;
                    var df_2 = sdrCounts[2] || 0;
                    var time = earliestFreqBySession[sessionId].time || 'N/A';
                    var frequency = earliestFreqBySession[sessionId].frequency || 'N/A';

                    var sessionItem = document.createElement('div');
                    sessionItem.classList.add('session-item');

                    var checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = 'session-' + sessionId;
                    checkbox.name = 'session-' + sessionId;

                    // Основной обработчик события для чекбоксов сессий
                    checkbox.addEventListener('change', function() {
                        if (checkbox.checked) {
                            if (!sessionLinesMap[sessionId] && linesBySession[sessionId]) {
                                sessionLinesMap[sessionId] = [];
                                linesBySession[sessionId].forEach(line => {
                                    var polyline = L.polyline(line, {color: 'blue', weight: 1}).addTo(map);
                                    sessionLinesMap[sessionId].push(polyline);
                                });
                            }
                        } else {
                            if (sessionLinesMap[sessionId]) {
                                sessionLinesMap[sessionId].forEach(polyline => {
                                    map.removeLayer(polyline);
                                });
                                delete sessionLinesMap[sessionId];
                            }
                        }
                    });

                    var label = document.createElement('label');
                    label.setAttribute('for', 'session-' + sessionId);
                    label.innerText = index + ' ' + frequency + ' ' + time + ' ' + df_1 + ' ' + df_2;

                    sessionItem.appendChild(checkbox);
                    sessionItem.appendChild(label);
                    sessionList.appendChild(sessionItem);
                }
            });

            coordinates.forEach(coord => {
                L.marker(coord, {
                    icon: L.icon({
                        iconUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowUrl: null
                    })
                }).addTo(map);
            });
        })
        .catch(error => {
            console.error('Error fetching coordinates:', error);
        });
    </script>
</body>
</html>
